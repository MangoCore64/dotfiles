# Neovim 配置架構設計

## 概述

本 Neovim 配置基於 NvChad v2.5 框架構建，專注於 AI 輔助開發和現代化工作流程。系統採用模組化設計，強調可維護性、性能和安全性。

## 核心設計原則

### 1. 模組化架構
- **關注點分離**：每個模組負責單一職責
- **低耦合高內聚**：模組間通過明確介面通訊
- **可擴展性**：易於添加新功能而不影響現有系統

### 2. 性能優先
- **延遲載入**：使用 lazy.nvim 實現按需載入
- **非同步操作**：避免阻塞主執行緒
- **資源管理**：自動清理和記憶體優化

### 3. 安全設計
- **敏感資料保護**：自動過濾剪貼板中的敏感資訊
- **輸入驗證**：所有外部輸入都經過驗證
- **錯誤隔離**：錯誤不會影響整體系統穩定性

## 系統架構圖

```
┌─────────────────────────────────────────────────────────┐
│                     使用者介面層                         │
│  ┌─────────────┐  ┌──────────────┐  ┌───────────────┐ │
│  │  快捷鍵映射  │  │  浮動視窗    │  │  狀態顯示     │ │
│  │ (mappings)   │  │  (UI模組)    │  │  (statusline) │ │
│  └─────────────┘  └──────────────┘  └───────────────┘ │
└─────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────┐
│                     應用邏輯層                           │
│  ┌─────────────┐  ┌──────────────┐  ┌───────────────┐ │
│  │ 終端管理器   │  │  剪貼板工具  │  │  性能監控     │ │
│  │ (terminal/   │  │  (clipboard)  │  │ (performance- │ │
│  │  manager)    │  │              │  │  monitor)     │ │
│  └─────────────┘  └──────────────┘  └───────────────┘ │
└─────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────┐
│                     核心服務層                           │
│  ┌─────────────┐  ┌──────────────┐  ┌───────────────┐ │
│  │ 狀態管理     │  │  安全模組    │  │  錯誤處理     │ │
│  │ (terminal/   │  │  (security)   │  │ (error-       │ │
│  │  state)      │  │              │  │  handler)     │ │
│  └─────────────┘  └──────────────┘  └───────────────┘ │
└─────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────┐
│                    基礎設施層                            │
│  ┌─────────────┐  ┌──────────────┐  ┌───────────────┐ │
│  │   NvChad     │  │  Lazy.nvim   │  │   Neovim API  │ │
│  │  Framework   │  │  Plugin Mgr  │  │               │ │
│  └─────────────┘  └──────────────┘  └───────────────┘ │
└─────────────────────────────────────────────────────────┘
```

## 模組詳解

### 1. 終端管理系統

終端管理是本配置的核心功能，提供 AI 工具（Claude Code、Gemini）的無縫整合。

#### 核心模組結構
```
lua/utils/
├── terminal/manager.lua      # 協調器，管理終端切換和狀態
├── terminal/adapters/claude.lua       # Claude Code 適配器
├── terminal/adapters/gemini.lua       # Gemini CLI 適配器
├── terminal/state.lua        # 狀態管理
└── terminal/                 # 核心終端功能
    ├── init.lua             # 統一 API 入口
    ├── core.lua             # 核心終端操作
    ├── security.lua         # 安全驗證
    └── ui.lua               # UI 相關功能
```

#### 設計特點
- **統一介面**：所有終端通過相同 API 管理
- **錯誤恢復**：3 層重試機制，智能錯誤分類
- **狀態隔離**：每個終端維護獨立狀態
- **性能優化**：切換操作 < 200ms

### 2. 剪貼板管理系統

#### 功能特色
- **安全過濾**：自動檢測並過濾敏感資訊
- **智能分段**：大型選擇自動分段處理
- **檔案參考模式**：生成 `path:line` 格式節省 token
- **OSC 52 支援**：VM/SSH 環境相容

#### 安全機制
```lua
-- 敏感資訊模式匹配
local sensitive_patterns = {
  api_keys = "sk%-[A-Za-z0-9]+",
  tokens = "[A-Za-z0-9]{40,}",
  passwords = "password[\"']?%s*[:=]%s*[\"'][^\"']+",
}
```

### 3. 性能監控系統

#### 監控指標
- **啟動時間追蹤**：里程碑式記錄
- **記憶體使用監控**：自動警告閾值
- **操作計時**：關鍵操作性能基準
- **健康評估**：綜合健康分數計算

#### 自動化功能
- 定期記憶體檢查（每 60 秒）
- 歷史數據清理（保留 7 天）
- 性能報告生成
- 異常自動警告

### 4. 錯誤處理系統

#### 三層錯誤處理
1. **局部處理**：模組內部 pcall 包裝
2. **統一處理**：error-handler 集中管理
3. **用戶通知**：vim.notify 友好提示

#### 錯誤恢復策略
```lua
-- 錯誤類型和對應恢復策略
local ERROR_TYPES = {
  TIMEOUT = "操作超時",           -- 解除鎖定
  INVALID_STATE = "無效狀態",     -- 清理狀態
  RESOURCE_CONFLICT = "資源衝突", -- 釋放資源
  COMMAND_FAILED = "命令失敗",    -- 重新初始化
}
```

## 配置載入流程

```
1. init.lua
   ├── 載入 NvChad 核心
   ├── 設定基礎選項
   └── 載入自定義配置
       ├── chadrc.lua (UI/主題)
       ├── options.lua (編輯器選項)
       ├── mappings.lua (快捷鍵)
       └── plugins/ (插件定義)
           └── 延遲載入各功能模組
```

## 插件管理策略

### 載入優先級
1. **立即載入** (`lazy = false`)
   - 核心功能插件
   - UI 基礎組件
   - 終端管理系統

2. **事件觸發載入**
   - LSP 相關（BufReadPre）
   - 語法高亮（BufRead）
   - 文件類型特定插件

3. **命令觸發載入**
   - 偶爾使用的工具
   - 大型功能插件

## 性能優化策略

### 1. 啟動優化
- NvChad 提供的優化基礎
- 延遲載入非必要插件
- 避免同步操作

### 2. 運行時優化
- 異步終端操作
- 智能緩存機制
- 資源自動清理

### 3. 記憶體管理
- 定期垃圾回收
- Buffer 生命週期管理
- 大文件處理優化

## 安全考量

### 1. 輸入驗證
- 所有用戶輸入經過驗證
- 路徑規範化防止遍歷攻擊
- 命令注入防護

### 2. 敏感資料保護
- 剪貼板自動過濾
- 日誌脫敏處理
- 環境變數隔離

### 3. 錯誤資訊安全
- 錯誤訊息不洩露系統路徑
- 堆疊追蹤過濾
- 用戶友好的錯誤提示

## 擴展指南

### 添加新的 AI 工具
1. 創建適配器模組 (`terminal/adapters/[tool].lua`)
2. 實現標準介面（open, close, toggle, is_visible）
3. 在 terminal/init.lua 註冊
4. 添加快捷鍵映射

### 添加新功能
1. 遵循模組化原則
2. 使用現有的錯誤處理機制
3. 整合性能監控
4. 提供健康檢查

## 維護建議

### 定期檢查
- 運行健康檢查：`:lua require('utils.terminal.manager').health_check()`
- 查看性能報告：`:lua require('utils.performance-monitor').show_report()`
- 檢查錯誤日誌：查看 vim.notify 歷史

### 更新策略
- 定期更新 NvChad 核心
- 測試插件相容性
- 保持文檔同步

## 結論

本架構設計強調模組化、性能和安全性，提供了一個穩定、高效且易於擴展的 Neovim 開發環境。通過清晰的層次結構和明確的職責劃分，系統易於理解和維護。