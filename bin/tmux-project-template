#!/bin/bash
# tmux å°ˆæ¡ˆç¯„æœ¬è…³æœ¬ç”Ÿæˆå™¨
# ä½¿ç”¨æ–¹æ³•: ./tmux-project-template <project_name> <project_path>
# æœƒåœ¨ ~/bin/ ç›®éŒ„ä¸‹å»ºç«‹å°æ‡‰çš„å°ˆæ¡ˆè…³æœ¬

if [ $# -ne 2 ]; then
    echo "ä½¿ç”¨æ–¹æ³•: $0 <project_name> <project_path>"
    echo "ç¯„ä¾‹: $0 myapp ~/projects/myapp"
    echo "ç¯„ä¾‹: $0 webapp ~/dev/webapp"
    exit 1
fi

PROJECT_NAME="$1"
PROJECT_PATH="$2"
SCRIPT_PATH="$HOME/bin/tmux-$PROJECT_NAME"

# ç¢ºä¿ ~/bin ç›®éŒ„å­˜åœ¨
mkdir -p "$HOME/bin"

# ç”Ÿæˆå°ˆæ¡ˆè…³æœ¬
cat > "$SCRIPT_PATH" << 'EOF'
#!/bin/bash
# Session-Per-Project æ¨™æº–è…³æœ¬: PROJECT_NAME å°ˆæ¡ˆ
# ç”± tmux-project-template ç”Ÿæˆï¼Œä¸ç´å…¥ dotfiles ç‰ˆæ§

SESSION="SESSION_NAME"
PROJECT_PATH="PROJECT_PATH_VALUE"

# æª¢æŸ¥å°ˆæ¡ˆç›®éŒ„æ˜¯å¦å­˜åœ¨
if [ ! -d "$PROJECT_PATH" ]; then
    echo "å°ˆæ¡ˆç›®éŒ„ä¸å­˜åœ¨: $PROJECT_PATH"
    echo "è«‹å…ˆå»ºç«‹å°ˆæ¡ˆç›®éŒ„æˆ–ä¿®æ”¹ PROJECT_PATH è®Šæ•¸"
    exit 1
fi

# æª¢æŸ¥æ˜¯å¦å·²åœ¨ tmux session ä¸­
if [ -n "$TMUX" ]; then
    # åœ¨ tmux ä¸­ï¼Œç›´æ¥åˆ‡æ›åˆ°ç›®æ¨™ session
    tmux switch-client -t $SESSION 2>/dev/null || {
        echo "Session $SESSION ä¸å­˜åœ¨ï¼Œå»ºç«‹æ–° session..."
        # å¾ç•¶å‰ tmux ä¸­å»ºç«‹æ–° session
        tmux new-session -d -s $SESSION -c "$PROJECT_PATH"
        tmux switch-client -t $SESSION
    }
else
    # ä¸åœ¨ tmux ä¸­ï¼Œæª¢æŸ¥ session æ˜¯å¦å­˜åœ¨
    tmux has-session -t $SESSION 2>/dev/null
    if [ $? != 0 ]; then
        echo "å»ºç«‹æ–°çš„ tmux session: $SESSION"
        
        # å»ºç«‹æ–° session ä¸¦è¨­å®šå·¥ä½œç›®éŒ„
        tmux new-session -d -s $SESSION -c "$PROJECT_PATH"
        
        # Window 1: Editor (ä¸»ç·¨è¼¯å™¨) - tmux é è¨­å¾ 1 é–‹å§‹
        tmux rename-window -t $SESSION:1 'editor'
        tmux send-keys -t $SESSION:1 'clear && echo "Welcome to SESSION_NAME project!"' C-m
        
        # Window 2: Git (Git æ“ä½œå°ˆç”¨)
        tmux new-window -t $SESSION -n 'git' -c "$PROJECT_PATH"
        tmux send-keys -t $SESSION:git 'clear && git status' C-m
        
        # Window 3: Server (é–‹ç™¼ä¼ºæœå™¨/æ§‹å»ºå·¥å…·)
        tmux new-window -t $SESSION -n 'server' -c "$PROJECT_PATH"
        tmux send-keys -t $SESSION:server 'clear && echo "Server/Build window ready"' C-m
        # å–æ¶ˆè¨»è§£ä¸‹è¡Œä¾†è‡ªå‹•å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨ï¼Œæ ¹æ“šå°ˆæ¡ˆé¡å‹èª¿æ•´å‘½ä»¤ï¼š
        # tmux send-keys -t $SESSION:server 'npm run dev' C-m      # Node.js
        # tmux send-keys -t $SESSION:server 'python manage.py runserver' C-m  # Django
        # tmux send-keys -t $SESSION:server 'rails server' C-m     # Rails
        
        # Window 4: Terminal (ä¸€èˆ¬çµ‚ç«¯æ“ä½œ)
        tmux new-window -t $SESSION -n 'term' -c "$PROJECT_PATH"
        tmux send-keys -t $SESSION:term 'clear' C-m
        
        # ç­‰å¾…æ‰€æœ‰ window å»ºç«‹å®Œæˆå¾Œå†å•Ÿå‹• nvim
        sleep 0.5
        tmux send-keys -t $SESSION:editor 'nvim .' C-m
        
        # é è¨­èšç„¦åœ¨ editor window
        tmux select-window -t $SESSION:editor
        
        echo "Session $SESSION å»ºç«‹å®Œæˆï¼"
        echo "Windows: editor | git | server | term"
        echo "ğŸ’¡ æç¤º: nvim æœƒè‡ªå‹•è¼‰å…¥æ­¤ç›®éŒ„çš„æœƒè©± (persistence.nvim)"
    else
        echo "é€£æ¥åˆ°ç¾æœ‰ session: $SESSION"
    fi
    
    # é€£æ¥åˆ° session
    tmux attach-session -t $SESSION
fi
EOF

# æ›¿æ›ç¯„æœ¬è®Šæ•¸
sed -i "s/SESSION_NAME/$PROJECT_NAME/g" "$SCRIPT_PATH"
sed -i "s/PROJECT_NAME/$PROJECT_NAME/g" "$SCRIPT_PATH"
sed -i "s|PROJECT_PATH_VALUE|$PROJECT_PATH|g" "$SCRIPT_PATH"

# è¨­å®šç‚ºå¯åŸ·è¡Œ
chmod +x "$SCRIPT_PATH"

echo "âœ… å°ˆæ¡ˆè…³æœ¬å·²å»ºç«‹: $SCRIPT_PATH"
echo "ğŸš€ ä½¿ç”¨æ–¹æ³•:"
echo "   $SCRIPT_PATH           # å•Ÿå‹•/é€£æ¥å°ˆæ¡ˆ"
echo "   alias $PROJECT_NAME='$SCRIPT_PATH'  # å»ºè­°åŠ åˆ° ~/.bashrc"
echo ""
echo "ğŸ“ è…³æœ¬ç‰¹è‰²:"
echo "   - è‡ªå‹•å»ºç«‹ 4 å€‹ windows: editor/git/server/term"
echo "   - nvim æœƒè‡ªå‹•è¼‰å…¥ç›®éŒ„æœƒè©± (persistence.nvim)"
echo "   - æ”¯æ´åœ¨ tmux å…§å¤–å•Ÿå‹•"
echo "   - ä¸ç´å…¥ dotfiles ç‰ˆæ§ (å­˜æ”¾åœ¨ ~/bin/)"